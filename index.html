<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        video {
            border: 2px solid #333;
            width: 100%;
            max-width: 400px;
            height: auto;
        }
        #photos {
            margin-top: 20px;
        }
        .photo-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .photo-container img {
            width: 100px;
            height: auto;
            margin-right: 10px;
        }
        .photo-container input {
            flex-grow: 1;
            padding: 5px;
            font-size: 14px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .controls button, .controls input {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Camera Toolb</h1>
    <video id="video" autoplay playsinline></video>
    <div class="controls">
        <button id="switch-camera">Switch Camera</button>
        <button id="capture">Capture</button>
        <button id="save">Save File</button>
        <input type="file" id="load" accept=".json" style="display: none;">
        <button id="load-btn">Load File</button>
        <button id="new-session">New Session</button>
    </div>
    <div id="photos"></div>

    <script>
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture');
        const switchCameraButton = document.getElementById('switch-camera');
        const saveButton = document.getElementById('save');
        const loadButton = document.getElementById('load');
        const loadFileButton = document.getElementById('load-btn');
        const newSessionButton = document.getElementById('new-session');
        const photosDiv = document.getElementById('photos');
        let currentStream = null;
        let useFrontCamera = false; // Start with the rear camera
        let db; // IndexedDB reference

        // Open IndexedDB
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("PhotoSessionDB", 1);
                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
                };
                request.onsuccess = function (event) {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        };

        // Resize the image to reduce size
        const resizeImage = (imageData, maxWidth, maxHeight) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imageData;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/png'));
                };
            });
        };

        // Access the camera
        async function startCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                const videoConstraints = {
                    facingMode: useFrontCamera ? 'user' : 'environment'
                };

                const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
                currentStream = stream;
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera error:", err);
                alert("Unable to access the camera: " + err.message);
            }
        }

        // Switch camera button
        switchCameraButton.addEventListener('click', () => {
            useFrontCamera = !useFrontCamera;
            startCamera();
        });

        // Capture a picture
        captureButton.addEventListener('click', async () => {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            const isLandscape = window.matchMedia("(orientation: landscape)").matches;
            if (isLandscape) {
                canvas.width = video.videoHeight;
                canvas.height = video.videoWidth;
            } else {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png');

            // Resize the image before storing it
            const resizedImage = await resizeImage(imageData, 800, 600);

            // Store the resized image in IndexedDB
            const transaction = db.transaction("photos", "readwrite");
            const store = transaction.objectStore("photos");
            store.add({ image: resizedImage, text: '' });

            renderPhotos();
        });

        // Render photos from IndexedDB
        const renderPhotos = async () => {
            photosDiv.innerHTML = '';
            const transaction = db.transaction("photos", "readonly");
            const store = transaction.objectStore("photos");
            const photos = await store.getAll();
            photos.onsuccess = function () {
                photos.result.forEach((photo, index) => {
                    const container = document.createElement('div');
                    container.className = 'photo-container';

                    const img = document.createElement('img');
                    img.src = photo.image;
                    container.appendChild(img);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = 'Add a description...';
                    input.value = photo.text;
                    input.addEventListener('input', (e) => {
                        photo.text = e.target.value;

                        // Update IndexedDB entry
                        const updateTransaction = db.transaction("photos", "readwrite");
                        const updateStore = updateTransaction.objectStore("photos");
                        updateStore.put(photo);
                    });
                    container.appendChild(input);

                    photosDiv.appendChild(container);
                });
            };
        };

        // Clear session
        newSessionButton.addEventListener('click', () => {
            const confirmClear = confirm("Are you sure you want to start a new session? All unsaved photos and notes will be lost.");
            if (confirmClear) {
                const transaction = db.transaction("photos", "readwrite");
                const store = transaction.objectStore("photos");
                store.clear();
                renderPhotos();
            }
        });

        // Save photos to a JSON file
        saveButton.addEventListener('click', async () => {
            const transaction = db.transaction("photos", "readonly");
            const store = transaction.objectStore("photos");
            const photos = await store.getAll();

            const dataStr = JSON.stringify(photos);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19); // Format: YYYY-MM-DDTHH-MM-SS
            const filename = `photos-${timestamp}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();

            URL.revokeObjectURL(url);
        });

        // Load photos from a JSON file
        loadFileButton.addEventListener('click', () => {
            loadButton.click();
        });

        loadButton.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = JSON.parse(e.target.result);
                    const transaction = db.transaction("photos", "readwrite");
                    const store = transaction.objectStore("photos");
                    data.forEach(photo => store.add(photo));
                    renderPhotos();
                };
                reader.readAsText(file);
            }
        });

        // Initialize IndexedDB and camera on page load
        (async () => {
            await openDB();
            await renderPhotos();
            startCamera();
        })();
    </script>
</body>
</html>
